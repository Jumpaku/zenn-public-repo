---
title: "はじめに"
---

# このチャプターについて
このチャプターでは、この本を読むに当たっての注意点や本の内容についての説明を記載しています。次のチャプターを読みすすめる前に必ず確認するようにしてください。

# この本について

https://zenn.dev/estra/articles/js-async-programming-roadmap

上記の記事で "**非同期処理を理解できるようになるまでので学習ロードマップ**" についての内容を書きました。「学習のロードマップは分かったけど、より具体的な非同期処理のポイントも知りたい」といった要望について応えるためにこの本を書きました。

この本では、**非同期処理の真髄**と言っても過言ではない Promise チェーンとイベントループから非同期処理の重要であるポイントを解説しています。

この本の大きな目的としては「読者が**非同期処理の制御の流れを理解し、予測できるようになる**」ことを掲げています。また、**学習の過程で陥りがちなトラップや誤解**などについても実際の学習から得た知見で解説しているので、「非同期処理について学習してみたけど、やっぱり分からない」という方の誤解や勘違いを解きつつ「**非同期処理の謎を解明する**」ということも目標としています。

:::message alert
**なぜ今更プロミスチェーンなのか？**  

非同期処理の解説として「async/await」をメインに据えずに「プロミスチェーン」をタイトルに入れているのは大きな意味があります。直感に反して**非同期処理の主役は Promise であり**、非同期処理の動きを理解するための本質的な部分が **イベントループ上でのタスク・マイクタスクの連鎖的な処理(chain)** だからです。async/await で扱う Promise の性質を知るため、マイクロタスクが連鎖的に実行されることを理解するために、Promise チェーンが必要なのです。「急がば回れ」です。
:::

今回あえて Book(本) として公開している理由は、かなり長い内容になるので記事一本では書ききれないと感じたためです。追加の内容や修正などを頻繁に行う必要があるので、本を作るのも初めてなので今回は実験も兼ねて Book(本) で公開しています。

本としての体裁は取っていますが、自分自身のアウトプットを兼ねているため、この本は無料公開となっています。

この本では可能な限り正確な情報になるように努力していますが、学習者のアウトプットとしての側面も強いので、間違い等があるかもしれません。その点についてはご容赦ください。なにか不備や間違いを見つけた場合にはスクラップにて教えていただける非常に助かります。

# 構成について
本の構成としては、非同期 API とそれを提供する環境についての話から始め、イベントループへの理解を深めます。具体的な非同期処理については、Promise の基礎的概念から Promise チェーンへと続き、最終的にはそこまでのすべての知識と V8 エンジンからのアプローチによって async/await の挙動を理解します。

リアルタイムで学習した内容を反映させたり、勘違いしていた内容についての大規模な修正を追加したこともあり、以前は古い知見に基づいたチャプターと更新された新しい知見に基づいたチャプターが入り混じった構成になっていました。現時点ではほとんどすべてのチャプターを新しい知見に基づく解説に統一したので気にする必要はなくなりました。

例外的に『イベントループの概要と注意点』のチャプターだけはそのまま古い内容とそれについての訂正・注釈を残しています。誤解や間違いを直すための試行錯誤の過程が見て取れるので「そういう資料」であると思って読み進めてください。

:::message
この本を章分けするなら以下のようになります。構成としてしっかり章分けしているわけではないので目安程度に考えてください。

- 第１章: API を提供する実行環境と JavaScript の実行メカニズム (チャプター 02 ~ 07)
- 第２章: Promise インスタンスと Promise チェーン (チャプター 08 ~ 21)
- 第３章: await 式の挙動 (チャプター 22 ~ 24)

第１章の内容はよりメタ的な視点での解説なので、先取りで Promise の知識(第２章の内容)を利用している場合があります。難しい場合は、ざっと目を通して第２章の内容を読み進めるのが良いかもしれません。
:::

# 前準備
この本の内容を理解するために、JSConfEU での Philip Roberts 氏の講演動画である『What the heck is the event loop anyway?』をはじめに見ることを強く推奨しています。

@[youtube](8aGhZQkoFbQ)

この動画で、"イベントループ"と"コールスタック"、"非同期 API" の概要を掴んでからこの本の内容を読んでいただけると良いと思います。

# 参考文献について
各チャプターのいたるところで参考となる文献やリソースの URL を貼っておきます。もちろん、この本１つで非同期処理を完全に理解することは難しいので、それらを含めたインターネット上のあらゆる他のリソースを併用することをおすすめしています(非同期処理を理解するのには多くの情報が必要なため、**１つのリソースだけでは情報が不足しすぎています**)。特に、この本で扱う領域は非同期処理の制御を予測するための基礎的な事象、あるいは本質的な事象を中心としています。**より応用的・実践的な話については他のリソースが必要となります**。

:::message
とは言え、非同期処理の解説等であまり語られていない、環境、V8 エンジン、マイクロタスクや実行コンテキストなどの概念が登場しますので読んで損がないようになっています。これによって非同期処理だけでなく、**付随的・必然的に JavaScript の実行メカニズムの基礎についても理解できるようになります**。
:::

参考になるドキュメントでは azu さんの『JavaScript Primer』が非常におすすめです。非同期処理の基礎やシンタックスについて網羅的に学ぶことができます。

https://jsprimer.net/basic/async/

もちろん、Mdn のドキュメントも必須です。何か細かいことを知りたくなったら、Mdn のドキュメントを読んでください。

https://developer.mozilla.org/ja/

動画では JSConfEU にアップロードされている動画が基本的におすすめです。ドキュメントよりも動画を使って視覚的に理解した方がいい場合が多々ありますので活用してください。JSConf の動画は本質情報が得られる場合が多いです。この本の中では『What the heck is the event loop anyway?』以外にもいくつかの動画を参照しています。

https://www.youtube.com/c/JSConfEU/videos?view=0&sort=p&shelf_id=0

:::message
Conf 系(NodeConf, ReactConf など)はオーソリティ性が確保されているのである程度安心してみることができます。基本的には最新のものが良いですが、JSConfEU の動画ではよく視聴されているものを見ておくと良いです。動画は英語ですが、平易な英語なので字幕などを活用して視聴してください。
:::

これら以外で細かい学習リソースに困ったら、『非同期処理を理解できるようになるまでので学習ロードマップ』の記事に挙げたリソースなどを参考にしてもらえばいいかと思います。

# スクラップについて
この本に関する感想や質問等あれば、紐付けられたスクラップの方へどうぞ。

https://zenn.dev/estra/scraps/20dc6c4a1b64f8

間違いや誤植等を見つけた場合には教えていただけるとありがたいです。

# 表記について
イベントループで Promise チェーンがどのように動くか "JavaScript Visualizer 9000 "というツールをこの本の各所で使用していきます。名前が長いので、以降「JS Visualizer」と呼称します。

また、関数の引数に渡すコールバック関数について `then(cb)` や `then(callback)` のように `cb` や `callback` と省略表記する場合があるので注意してください。

ECMAScript や HTML Living standard, Node.js などで同じものを表す場合に用語が違ったりするのでまとめておきます。また途中ででてくる単語に表記ゆれがあった場合もこちらを参照してください。

| 元々のワード | 別の表記 |
|--|--|
| Message loop | Event loop, イベントループ |
| Task | Macrotask, マクロタスク、タスク |
| Task queue | Macrotask queue, マクロタスクキュー, タスクキュー |
| Job | ジョブ, Microtask, マイクロタスク |
| Job queue | ジョブキュー, Microtask queue, マイクロタスクキュー |

混乱を避けるために次の言葉を意図的に使用するようにします。また、英単語を記載する際には大文字から始めるようにします。

- Event loop (またはイベントループ)
- Task (またはタスク)
- Microtask (またはマイクロタスク) 

:::message
最初は Task(タスク) よりも Macrotask(マクロタスク) の単語の方が理解しやすいかと思っていたのですが、Task(タスク) 方が本質を捉えやすい言葉だと感じたのでこちらをなるべく使っていきたいと思います。

加えて Macro と Micro は似ているので見間違いやすいという理由もあります。
:::

# 使用する環境とJSエンジン
この記事では実際のコードを通して、Promise チェーンがどのような制御で実行されるかを確認していきます。この本を読む際にはぜひ自分で実行してみるようにしてください。

JavaScript と一言で言っても様々な環境で使用される言語ですから、どういった環境で使用するかを考える必要があります。

- Chrome などのブラウザ環境
- Node や Deno といったランタイム環境

自分は Deno がお気に入りなので、この本の説明で使用する JavaScript の実行は主に Deno ランタイム環境で行っています。

https://deno.land

使用する Deno のバージョンは以下のものとなります。

```sh
❯ deno -V
deno 1.20.4
```

Deno ではデフォルトで TypeScript を設定無しにすぐに実行できるので、**最終的に TypeScript で Promise の型を考える**ために使っているという側面もあります。

サーバーなどは立てずに、以下の様にターミナル等から `deno run` コマンドを使ってローカル環境で JavaScript を実行していきます。`node` でもいいですが、これが JavaScript の非同期処理をテストするための最も早く手軽な方法です。

```sh:コマンドライン
❯ deno run helloWorld.js
hello world!
```

後のチャプターで詳しく解説しますが、Chrome ブラウザ環境や Node, Deno といったランタイム環境において**イベントループの本質的な部分は共通しています**。とはいえ環境による違いもあるので、それについても解説しておきました。つまり、この本では、代表的な複数の環境において JavaScript の非同期処理を包括的に考えます。

というわけで、Node 環境についても考える場面があるので `node` コマンドを使用している際には次のバージョンで考えください。

```sh
❯ node -v
v18.2.0
```

そして、それらの環境に拘らずに考えるために途中から V8 エンジンを使用します。この V8 エンジンについても解説しますが、V8 エンジンは Chrome, Node, Deno, Electron などで使用されている JavaScritp エンジン(ECMAScript を実装しているもの)です。

この本で使用する V8 エンジンのバージョンは次のものとなります。

```sh
❯ v8
V8 version 10.3.154
```

# JS Visualizer 使用上の注意点

:::message alert
こちらの内容については今理解できなくても大丈夫です。疑問を抱いた時に確認してください。
:::

JS Visuzalizer では使用する上でいくつか注意点があります。

https://www.jsv9000.app

まずは、日本語が使えませんので、日本語を入力したり、日本語が含まれるコードをペーストしようとすると画面が白くなり固まります。

非同期処理を理解する上で初期は非常に有用ですが、使用して行くうちにいくつかの疑問点が湧いてくるはずです。自分自身が非同期処理を理解していく内に、この違和感に気づきました。

JS Visualizer では実装ミスとも言える点や勘違いしやすい点が実はいくつかあります。

- 環境での並列作業としての `setTimeout()` 関数などの Web API の概念が掴みづらく、タスクキューにタスクが挿入される順番に間違いと思われる部分があります
- イベントループには多くの場合、タスクキューが１つ以上あるため、タスクキューが１つであると勘違いする可能性が高いです
- コールスタックに積まれるコンテキストとして必要なグローバルコンテキストが視覚化されていないため、最初のタスクやマイクロタスクの実行順番について誤解する可能性があります

そのため、この本でも途中から(新しい知見に基づいたチャプターでは)あまり使用しなくなりますが、イベントループのイメージを掴む上で非常に有用であることは変わりませんので気をつけて使ってください。

# ChangeLog
大きな変更のみトラッキングしています。

:::details ChangeLog
- 2022-06-15
  - 新チャプター「同期 API とブロッキング」を追加
- 2022-06-06
  - すべてのチャプターの説明を新しい知見に基づく内容に書き換え完了
  - 新チャプター「エピローグ」を追加
- 2022-05-28
  - 新チャプター「Top-level await」を追加
- 2022-05-22
  - いくつかチャプターでの説明を加筆
- 2022-05-21
  - 全チャプターのフォーマットを統一
- 2022-05-14
  - 全体を完成
  - 新チャプター追加
    - ch「catch メソッドと finally メソッド」を追加
    - ch「Promise チェーンから非同期関数へ」を追加
    - ch「V8 エンジンによる async/await の内部変換」を追加
- 2022-05-06
  - 新チャプター追加
    - ch「コールスタックと実行コンテキスト」を追加
    - ch「それぞれのイベントループ」を追加
    - ch「タスクキューとマイクロタスクキュー」を追加
    - ch「V8 エンジン」を追加
    - ch「非同期 API と環境」を追加
    - ch「resolve 関数と reject 関数の使い方」を追加
  - ch「古い非同期 API を Promise でラップする」を改修
  - ch「イベントループは内部にネストしたループがある」を改修
- 2022-05-03
  - ch「then メソッドのコールバックで非同期処理」に「副作用とは」の項目を追加
  - 新チャプター「Promise の基本概念」を追加
- 2022-04-23
  - ch「then メソッドのコールバックで非同期処理」を大幅追記
- 2022-04-21
  - JavaScript Visuzalizer で共有したコードが文字化けしていたので修正
  - ch「Event loop の概要と注意点」を大幅に修正追記
    - それに伴い Event loop のステップについて各所を修正
  - ch「Promise コンストラクタと Executor 関数」で関数式とアロー関数の補足を追加
  - ch「コールバック関数の同期実行と非同期実行」で「コールバック関数はいつ実行される?」の項目を追加
  - ch「then メソッドは常に新しい Promise を返す」で「Promise の状態を確かめる」の項目を追加
  - ch「Promise チェーンで値を繋ぐ」で「チェーンの最後まで値を繋ぐ」の項目を追加
  - ch「Promise チェーンはネストさせない」で「fetch の例[作成中]」の項目を追加
  - ch「Event loop は内部にネストしたループがある」を追加
  - その他全体的に加筆修正
  - コードの表記を修正
:::

